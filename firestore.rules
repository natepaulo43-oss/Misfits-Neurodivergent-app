rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getSignedInUserData() {
      return isSignedIn()
        ? (
            exists(/databases/$(database)/documents/users/$(request.auth.uid))
              ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
              : null
          )
        : null;
    }

    function getUserRole() {
      let userData = getSignedInUserData();
      return userData == null ? null : userData.role;
    }
    
    function isAdmin() {
      return isSignedIn() && getUserRole() in ['admin', 'super_admin'];
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAccountActive() {
      let userData = getSignedInUserData();
      // Default to true (active) if no user doc yet or field doesn't exist
      return userData == null || userData.accountSuspended != true;
    }
    
    function canMessage() {
      let userData = getSignedInUserData();
      // Default to true (can message) if no user doc yet or fields don't exist
      return (
        userData == null ||
        (userData.messagingDisabled != true && userData.accountSuspended != true)
      );
    }

    function canManageMentorAvailability(mentorId) {
      return isSignedIn() &&
        isOwner(mentorId);
    }
    
    // ============================================
    // Users Collection
    // ============================================
    
    match /users/{userId} {
      // Users can read their own document
      // Admins can read all users
      // All authenticated users can read basic user info (for messaging, matching)
      allow read: if isSignedIn();
      
      // Users can create their own document (initial signup/onboarding)
      allow create: if isOwner(userId);
      
      // Users can update their own document (profile updates)
      // Only blocked if account is suspended OR they're trying to suspend themselves
      allow update: if isOwner(userId) && 
        !resource.data.get('accountSuspended', false) &&
        !request.resource.data.get('accountSuspended', false);
      
      // Admins can write any user document
      allow write: if isAdmin();
    }
    
    // ============================================
    // Message Threads Collection
    // ============================================
    
    match /threads/{threadId} {
      // Participants can read their threads
      allow get: if isSignedIn() && 
        request.auth.uid in resource.data.participantIds;
      
      // Allow authenticated users to list/query threads to find existing conversations
      // This is needed for the findExistingThread query in startNewThread
      allow list: if isSignedIn();
      
      // Any authenticated user can create a thread
      // The app logic (ensureMessagingAllowed) handles additional checks
      allow create: if isSignedIn() &&
        request.auth.uid in request.resource.data.participantIds;
      
      // Participants can update thread metadata (lastMessage, etc.)
      allow update: if isSignedIn() &&
        request.auth.uid in resource.data.participantIds;
      
      // Admins can read all threads (for moderation)
      allow read: if isAdmin();
      
      // Admins cannot delete threads (preserve audit trail)
      allow delete: if false;
      
      // ============================================
      // Messages Subcollection
      // ============================================
      
      match /messages/{messageId} {
        // Participants can read messages in their threads
        allow read: if isSignedIn() && 
          request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.participantIds;
        
        // Participants can create messages in their threads
        // The app logic (ensureMessagingAllowed) handles additional checks
        allow create: if isSignedIn() &&
          request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.participantIds &&
          request.auth.uid == request.resource.data.fromUserId;
        
        // Admins can read all messages (for moderation)
        allow read: if isAdmin();
        
        // Admins can update messages (for flagging/review)
        allow update: if isAdmin();
        
        // Messages cannot be deleted (preserve audit trail)
        allow delete: if false;
      }
    }
    
    // ============================================
    // Curated Content Collection
    // ============================================
    
    match /curatedContent/{contentId} {
      // Everyone can read published content
      allow read: if resource.data.status == 'published';
      
      // Admins can read all content (including drafts)
      allow read: if isAdmin();
      
      // Admins can create, update, and delete content
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // Matches Collection
    // ============================================
    
    match /matches/{matchId} {
      // Students and mentors can read their own matches
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        request.auth.uid == resource.data.mentorId
      );
      
      // Admins can read all matches
      allow read: if isAdmin();
      
      // Admins can create, update, and delete matches
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // Mentor Availability Collection
    // ============================================
    
    match /mentorAvailability/{mentorId} {
      // Anyone can read mentor availability (for booking)
      allow read: if isSignedIn();
      
      // Mentors can create/update their own availability
      allow create, update: if canManageMentorAvailability(mentorId);
      
      // Admins can read/write all availability
      allow read, write: if isAdmin();
      
      // No one can delete availability (preserve data)
      allow delete: if false;
    }
    
    // ============================================
    // Sessions Collection
    // ============================================
    
    match /sessions/{sessionId} {
      // Students and mentors can read their own sessions
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        request.auth.uid == resource.data.mentorId
      );
      
      // Students can create session requests (where they are the student)
      allow create: if isSignedIn() && 
        isAccountActive() &&
        request.auth.uid == request.resource.data.studentId &&
        getUserRole() == 'student';
      
      // Students can update limited fields on their sessions
      // (accept reschedule, cancel)
      allow update: if isSignedIn() && 
        isAccountActive() &&
        request.auth.uid == resource.data.studentId &&
        (
          // Can only update status to cancelled or confirmed (from reschedule_proposed)
          (request.resource.data.status == 'cancelled') ||
          (resource.data.status == 'reschedule_proposed' && 
           request.resource.data.status == 'confirmed')
        );
      
      // Mentors can update their sessions
      // (accept, decline, propose reschedule, mark complete, cancel)
      allow update: if isSignedIn() && 
        isAccountActive() &&
        request.auth.uid == resource.data.mentorId &&
        getUserRole() == 'mentor';
      
      // Admins can read all sessions
      allow read: if isAdmin();
      
      // Admins can create, update, and delete sessions
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // Session Notes Collection (Mentor Private)
    // ============================================
    
    match /sessionNotes/{noteId} {
      // Only the mentor who created the note can read it
      allow read: if isSignedIn() && 
        request.auth.uid == resource.data.mentorId;
      
      // Mentors can create notes for their sessions
      allow create: if isSignedIn() && 
        isAccountActive() &&
        request.auth.uid == request.resource.data.mentorId &&
        getUserRole() == 'mentor';
      
      // Mentors can update their own notes
      allow update: if isSignedIn() && 
        isAccountActive() &&
        request.auth.uid == resource.data.mentorId;
      
      // Admins can read all notes (for oversight)
      allow read: if isAdmin();
      
      // Admins can create/update notes
      allow create, update: if isAdmin();
      
      // No one can delete notes (preserve audit trail)
      allow delete: if false;
    }
    
    // ============================================
    // Books Collection (Future - Currently Mock Data)
    // ============================================
    
    match /books/{bookId} {
      // Everyone can read approved books
      allow read: if resource.data.approved == true;
      
      // Admins can read all books
      allow read: if isAdmin();
      
      // Admins can create, update, and delete books
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // Book Purchases Collection (Future)
    // ============================================
    
    match /purchases/{purchaseId} {
      // Users can read their own purchases
      allow read: if isOwner(resource.data.userId);
      
      // Users can create their own purchases
      allow create: if isOwner(request.resource.data.userId) && isAccountActive();
      
      // Admins can read all purchases
      allow read: if isAdmin();
    }
  }
}

[debug] [2026-01-16T06:11:34.971Z] ----------------------------------------------------------------------
[debug] [2026-01-16T06:11:34.976Z] Command:       C:\Program Files\nodejs\node.exe C:\Users\Nate\AppData\Roaming\npm\node_modules\firebase-tools\lib\bin\firebase.js deploy --only firestore:rules
[debug] [2026-01-16T06:11:34.977Z] CLI Version:   14.25.0
[debug] [2026-01-16T06:11:34.977Z] Platform:      win32
[debug] [2026-01-16T06:11:34.978Z] Node Version:  v22.19.0
[debug] [2026-01-16T06:11:34.978Z] Time:          Fri Jan 16 2026 01:11:34 GMT-0500 (Eastern Standard Time)
[debug] [2026-01-16T06:11:34.979Z] ----------------------------------------------------------------------
[debug] 
[debug] [2026-01-16T06:11:35.285Z] > command requires scopes: ["email","openid","https://www.googleapis.com/auth/cloudplatformprojects.readonly","https://www.googleapis.com/auth/firebase","https://www.googleapis.com/auth/cloud-platform"]
[debug] [2026-01-16T06:11:35.286Z] > authorizing via signed-in user (natepaulo43@gmail.com)
[debug] [2026-01-16T06:11:35.286Z] [iam] checking project misfits-fe486 for permissions ["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]
[debug] [2026-01-16T06:11:35.289Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:35.289Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:35.291Z] >>> [apiv2][query] POST https://cloudresourcemanager.googleapis.com/v1/projects/misfits-fe486:testIamPermissions [none]
[debug] [2026-01-16T06:11:35.291Z] >>> [apiv2][(partial)header] POST https://cloudresourcemanager.googleapis.com/v1/projects/misfits-fe486:testIamPermissions x-goog-quota-user=projects/misfits-fe486
[debug] [2026-01-16T06:11:35.292Z] >>> [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/misfits-fe486:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[debug] [2026-01-16T06:11:35.956Z] <<< [apiv2][status] POST https://cloudresourcemanager.googleapis.com/v1/projects/misfits-fe486:testIamPermissions 200
[debug] [2026-01-16T06:11:35.957Z] <<< [apiv2][body] POST https://cloudresourcemanager.googleapis.com/v1/projects/misfits-fe486:testIamPermissions {"permissions":["datastore.indexes.create","datastore.indexes.delete","datastore.indexes.list","datastore.indexes.update","firebase.projects.get"]}
[info] 
[info] === Deploying to 'misfits-fe486'...
[info] 
[info] i  deploying firestore 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[info] i  firestore: ensuring required API firestore.googleapis.com is enabled... 
[debug] [2026-01-16T06:11:35.963Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:35.963Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:35.964Z] >>> [apiv2][query] GET https://firestore.googleapis.com/v1/projects/misfits-fe486/databases/(default) [none]
[debug] [2026-01-16T06:11:36.511Z] <<< [apiv2][status] GET https://firestore.googleapis.com/v1/projects/misfits-fe486/databases/(default) 200
[debug] [2026-01-16T06:11:36.511Z] <<< [apiv2][body] GET https://firestore.googleapis.com/v1/projects/misfits-fe486/databases/(default) {"name":"projects/misfits-fe486/databases/(default)","uid":"38018065-2e16-48ee-9f73-c6240522453f","createTime":"2025-12-30T07:46:44.650070Z","updateTime":"2025-12-30T07:46:44.650070Z","locationId":"nam5","type":"FIRESTORE_NATIVE","concurrencyMode":"PESSIMISTIC","versionRetentionPeriod":"3600s","earliestVersionTime":"2026-01-16T05:11:36.668478Z","appEngineIntegrationMode":"DISABLED","keyPrefix":"s","pointInTimeRecoveryEnablement":"POINT_IN_TIME_RECOVERY_DISABLED","deleteProtectionState":"DELETE_PROTECTION_DISABLED","databaseEdition":"STANDARD","freeTier":true,"realtimeUpdatesMode":"REALTIME_UPDATES_MODE_ENABLED","etag":"IKON7LWzj5IDMOHAnMvx5JED"}
[info] i  firestore: reading indexes from firestore.indexes.json... 
[info] i  cloud.firestore: checking firestore.rules for compilation errors... 
[debug] [2026-01-16T06:11:36.514Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:36.514Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:36.514Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/misfits-fe486:test [none]
[debug] [2026-01-16T06:11:36.514Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/misfits-fe486:test [omitted]
[debug] [2026-01-16T06:11:36.969Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/misfits-fe486:test 200
[debug] [2026-01-16T06:11:36.970Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/misfits-fe486:test {"issues":[{"sourcePosition":{"fileName":"firestore.rules","line":43,"column":14,"currentOffset":1229,"endOffset":1238},"description":"Unused function: canMessage.","severity":"WARNING"}]}
[warn] !  [W] 43:14 - Unused function: canMessage. 
[info] +  cloud.firestore: rules file firestore.rules compiled successfully 
[debug] [2026-01-16T06:11:36.972Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:36.972Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:36.972Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/misfits-fe486/releases pageSize=10&pageToken=
[debug] [2026-01-16T06:11:37.152Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/misfits-fe486/releases 200
[debug] [2026-01-16T06:11:37.152Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/misfits-fe486/releases {"releases":[{"name":"projects/misfits-fe486/releases/cloud.firestore","rulesetName":"projects/misfits-fe486/rulesets/b0feaca8-d2bf-4173-89ea-030dcd799757","createTime":"2025-12-30T07:46:48.932707Z","updateTime":"2026-01-16T06:01:02.965057Z"}]}
[debug] [2026-01-16T06:11:37.153Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:37.153Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:37.153Z] >>> [apiv2][query] GET https://firebaserules.googleapis.com/v1/projects/misfits-fe486/rulesets/b0feaca8-d2bf-4173-89ea-030dcd799757 [none]
[debug] [2026-01-16T06:11:37.328Z] <<< [apiv2][status] GET https://firebaserules.googleapis.com/v1/projects/misfits-fe486/rulesets/b0feaca8-d2bf-4173-89ea-030dcd799757 200
[debug] [2026-01-16T06:11:37.328Z] <<< [apiv2][body] GET https://firebaserules.googleapis.com/v1/projects/misfits-fe486/rulesets/b0feaca8-d2bf-4173-89ea-030dcd799757 [omitted]
[info] i  firestore: uploading rules firestore.rules... 
[debug] [2026-01-16T06:11:37.331Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:37.331Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:37.331Z] >>> [apiv2][query] POST https://firebaserules.googleapis.com/v1/projects/misfits-fe486/rulesets [none]
[debug] [2026-01-16T06:11:37.331Z] >>> [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/misfits-fe486/rulesets [omitted]
[debug] [2026-01-16T06:11:37.671Z] <<< [apiv2][status] POST https://firebaserules.googleapis.com/v1/projects/misfits-fe486/rulesets 200
[debug] [2026-01-16T06:11:37.672Z] <<< [apiv2][body] POST https://firebaserules.googleapis.com/v1/projects/misfits-fe486/rulesets {"name":"projects/misfits-fe486/rulesets/abc03316-427d-44fa-8fee-4e245dbaa33b","source":{"files":[{"content":"rules_version = '2';\r\n\r\nservice cloud.firestore {\r\n  match /databases/{database}/documents {\r\n    \r\n    // ============================================\r\n    // Helper Functions\r\n    // ============================================\r\n    \r\n    function isSignedIn() {\r\n      return request.auth != null;\r\n    }\r\n    \r\n    function getSignedInUserData() {\r\n      return isSignedIn()\r\n        ? (\r\n            exists(/databases/$(database)/documents/users/$(request.auth.uid))\r\n              ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data\r\n              : null\r\n          )\r\n        : null;\r\n    }\r\n\r\n    function getUserRole() {\r\n      let userData = getSignedInUserData();\r\n      return userData == null ? null : userData.role;\r\n    }\r\n    \r\n    function isAdmin() {\r\n      return isSignedIn() && getUserRole() in ['admin', 'super_admin'];\r\n    }\r\n    \r\n    function isOwner(userId) {\r\n      return isSignedIn() && request.auth.uid == userId;\r\n    }\r\n    \r\n    function isAccountActive() {\r\n      let userData = getSignedInUserData();\r\n      // Default to true (active) if no user doc yet or field doesn't exist\r\n      return userData == null || userData.accountSuspended != true;\r\n    }\r\n    \r\n    function canMessage() {\r\n      let userData = getSignedInUserData();\r\n      // Default to true (can message) if no user doc yet or fields don't exist\r\n      return (\r\n        userData == null ||\r\n        (userData.messagingDisabled != true && userData.accountSuspended != true)\r\n      );\r\n    }\r\n\r\n    function canManageMentorAvailability(mentorId) {\r\n      return isSignedIn() &&\r\n        isOwner(mentorId);\r\n    }\r\n    \r\n    // ============================================\r\n    // Users Collection\r\n    // ============================================\r\n    \r\n    match /users/{userId} {\r\n      // Users can read their own document\r\n      // Admins can read all users\r\n      // All authenticated users can read basic user info (for messaging, matching)\r\n      allow read: if isSignedIn();\r\n      \r\n      // Users can create their own document (initial signup/onboarding)\r\n      allow create: if isOwner(userId);\r\n      \r\n      // Users can update their own document (profile updates)\r\n      // Only blocked if account is suspended OR they're trying to suspend themselves\r\n      allow update: if isOwner(userId) && \r\n        !resource.data.get('accountSuspended', false) &&\r\n        !request.resource.data.get('accountSuspended', false);\r\n      \r\n      // Admins can write any user document\r\n      allow write: if isAdmin();\r\n    }\r\n    \r\n    // ============================================\r\n    // Message Threads Collection\r\n    // ============================================\r\n    \r\n    match /threads/{threadId} {\r\n      // Participants can read their threads\r\n      allow get: if isSignedIn() && \r\n        request.auth.uid in resource.data.participantIds;\r\n      \r\n      // Allow authenticated users to list/query threads to find existing conversations\r\n      // This is needed for the findExistingThread query in startNewThread\r\n      allow list: if isSignedIn();\r\n      \r\n      // Any authenticated user can create a thread\r\n      // The app logic (ensureMessagingAllowed) handles additional checks\r\n      allow create: if isSignedIn() &&\r\n        request.auth.uid in request.resource.data.participantIds;\r\n      \r\n      // Participants can update thread metadata (lastMessage, etc.)\r\n      allow update: if isSignedIn() &&\r\n        request.auth.uid in resource.data.participantIds;\r\n      \r\n      // Admins can read all threads (for moderation)\r\n      allow read: if isAdmin();\r\n      \r\n      // Admins cannot delete threads (preserve audit trail)\r\n      allow delete: if false;\r\n      \r\n      // ============================================\r\n      // Messages Subcollection\r\n      // ============================================\r\n      \r\n      match /messages/{messageId} {\r\n        // Participants can read messages in their threads\r\n        allow read: if isSignedIn() && \r\n          request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.participantIds;\r\n        \r\n        // Participants can create messages in their threads\r\n        // The app logic (ensureMessagingAllowed) handles additional checks\r\n        allow create: if isSignedIn() &&\r\n          request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.participantIds &&\r\n          request.auth.uid == request.resource.data.fromUserId;\r\n        \r\n        // Admins can read all messages (for moderation)\r\n        allow read: if isAdmin();\r\n        \r\n        // Admins can update messages (for flagging/review)\r\n        allow update: if isAdmin();\r\n        \r\n        // Messages cannot be deleted (preserve audit trail)\r\n        allow delete: if false;\r\n      }\r\n    }\r\n    \r\n    // ============================================\r\n    // Curated Content Collection\r\n    // ============================================\r\n    \r\n    match /curatedContent/{contentId} {\r\n      // Everyone can read published content\r\n      allow read: if resource.data.status == 'published';\r\n      \r\n      // Admins can read all content (including drafts)\r\n      allow read: if isAdmin();\r\n      \r\n      // Admins can create, update, and delete content\r\n      allow create, update, delete: if isAdmin();\r\n    }\r\n    \r\n    // ============================================\r\n    // Matches Collection\r\n    // ============================================\r\n    \r\n    match /matches/{matchId} {\r\n      // Students and mentors can read their own matches\r\n      allow read: if isSignedIn() && (\r\n        request.auth.uid == resource.data.studentId ||\r\n        request.auth.uid == resource.data.mentorId\r\n      );\r\n      \r\n      // Admins can read all matches\r\n      allow read: if isAdmin();\r\n      \r\n      // Admins can create, update, and delete matches\r\n      allow create, update, delete: if isAdmin();\r\n    }\r\n    \r\n    // ============================================\r\n    // Mentor Availability Collection\r\n    // ============================================\r\n    \r\n    match /mentorAvailability/{mentorId} {\r\n      // Anyone can read mentor availability (for booking)\r\n      allow read: if isSignedIn();\r\n      \r\n      // Mentors can create/update their own availability\r\n      allow create, update: if canManageMentorAvailability(mentorId);\r\n      \r\n      // Admins can read/write all availability\r\n      allow read, write: if isAdmin();\r\n      \r\n      // No one can delete availability (preserve data)\r\n      allow delete: if false;\r\n    }\r\n    \r\n    // ============================================\r\n    // Sessions Collection\r\n    // ============================================\r\n    \r\n    match /sessions/{sessionId} {\r\n      // Students and mentors can read their own sessions\r\n      allow read: if isSignedIn() && (\r\n        request.auth.uid == resource.data.studentId ||\r\n        request.auth.uid == resource.data.mentorId\r\n      );\r\n      \r\n      // Students can create session requests (where they are the student)\r\n      allow create: if isSignedIn() && \r\n        isAccountActive() &&\r\n        request.auth.uid == request.resource.data.studentId &&\r\n        getUserRole() == 'student';\r\n      \r\n      // Students can update limited fields on their sessions\r\n      // (accept reschedule, cancel)\r\n      allow update: if isSignedIn() && \r\n        isAccountActive() &&\r\n        request.auth.uid == resource.data.studentId &&\r\n        (\r\n          // Can only update status to cancelled or confirmed (from reschedule_proposed)\r\n          (request.resource.data.status == 'cancelled') ||\r\n          (resource.data.status == 'reschedule_proposed' && \r\n           request.resource.data.status == 'confirmed')\r\n        );\r\n      \r\n      // Mentors can update their sessions\r\n      // (accept, decline, propose reschedule, mark complete, cancel)\r\n      allow update: if isSignedIn() && \r\n        isAccountActive() &&\r\n        request.auth.uid == resource.data.mentorId &&\r\n        getUserRole() == 'mentor';\r\n      \r\n      // Admins can read all sessions\r\n      allow read: if isAdmin();\r\n      \r\n      // Admins can create, update, and delete sessions\r\n      allow create, update, delete: if isAdmin();\r\n    }\r\n    \r\n    // ============================================\r\n    // Session Notes Collection (Mentor Private)\r\n    // ============================================\r\n    \r\n    match /sessionNotes/{noteId} {\r\n      // Only the mentor who created the note can read it\r\n      allow read: if isSignedIn() && \r\n        request.auth.uid == resource.data.mentorId;\r\n      \r\n      // Mentors can create notes for their sessions\r\n      allow create: if isSignedIn() && \r\n        isAccountActive() &&\r\n        request.auth.uid == request.resource.data.mentorId &&\r\n        getUserRole() == 'mentor';\r\n      \r\n      // Mentors can update their own notes\r\n      allow update: if isSignedIn() && \r\n        isAccountActive() &&\r\n        request.auth.uid == resource.data.mentorId;\r\n      \r\n      // Admins can read all notes (for oversight)\r\n      allow read: if isAdmin();\r\n      \r\n      // Admins can create/update notes\r\n      allow create, update: if isAdmin();\r\n      \r\n      // No one can delete notes (preserve audit trail)\r\n      allow delete: if false;\r\n    }\r\n    \r\n    // ============================================\r\n    // Books Collection (Future - Currently Mock Data)\r\n    // ============================================\r\n    \r\n    match /books/{bookId} {\r\n      // Everyone can read approved books\r\n      allow read: if resource.data.approved == true;\r\n      \r\n      // Admins can read all books\r\n      allow read: if isAdmin();\r\n      \r\n      // Admins can create, update, and delete books\r\n      allow create, update, delete: if isAdmin();\r\n    }\r\n    \r\n    // ============================================\r\n    // Book Purchases Collection (Future)\r\n    // ============================================\r\n    \r\n    match /purchases/{purchaseId} {\r\n      // Users can read their own purchases\r\n      allow read: if isOwner(resource.data.userId);\r\n      \r\n      // Users can create their own purchases\r\n      allow create: if isOwner(request.resource.data.userId) && isAccountActive();\r\n      \r\n      // Admins can read all purchases\r\n      allow read: if isAdmin();\r\n    }\r\n  }\r\n}\r\n","name":"firestore.rules"}]},"createTime":"2026-01-16T06:11:37.796639Z","metadata":{"services":["cloud.firestore"]}}
[debug] [2026-01-16T06:11:37.672Z] [rules] created ruleset projects/misfits-fe486/rulesets/abc03316-427d-44fa-8fee-4e245dbaa33b
[debug] [2026-01-16T06:11:37.672Z] [rules] releasing cloud.firestore/(default) with ruleset projects/misfits-fe486/rulesets/abc03316-427d-44fa-8fee-4e245dbaa33b
[debug] [2026-01-16T06:11:37.672Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:37.672Z] Checked if tokens are valid: true, expires at: 1768545148041
[debug] [2026-01-16T06:11:37.673Z] >>> [apiv2][query] PATCH https://firebaserules.googleapis.com/v1/projects/misfits-fe486/releases/cloud.firestore/(default) [none]
[debug] [2026-01-16T06:11:37.673Z] >>> [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/misfits-fe486/releases/cloud.firestore/(default) {"release":{"name":"projects/misfits-fe486/releases/cloud.firestore/(default)","rulesetName":"projects/misfits-fe486/rulesets/abc03316-427d-44fa-8fee-4e245dbaa33b"}}
[debug] [2026-01-16T06:11:38.051Z] <<< [apiv2][status] PATCH https://firebaserules.googleapis.com/v1/projects/misfits-fe486/releases/cloud.firestore/(default) 200
[debug] [2026-01-16T06:11:38.051Z] <<< [apiv2][body] PATCH https://firebaserules.googleapis.com/v1/projects/misfits-fe486/releases/cloud.firestore/(default) {"name":"projects/misfits-fe486/releases/cloud.firestore","rulesetName":"projects/misfits-fe486/rulesets/abc03316-427d-44fa-8fee-4e245dbaa33b","createTime":"2025-12-30T07:46:48.932707Z","updateTime":"2026-01-16T06:11:38.176955Z"}
[debug] [2026-01-16T06:11:38.052Z] [rules] updated release projects/misfits-fe486/releases/cloud.firestore
[info] +  firestore: released rules firestore.rules to cloud.firestore 
[info] 
[info] +  Deploy complete! 
[info] 
[info] Project Console: https://console.firebase.google.com/project/misfits-fe486/overview
[debug] [2026-01-16T06:11:43.269Z] Error: Timed out.
    at Timeout._onTimeout (C:\Users\Nate\AppData\Roaming\npm\node_modules\firebase-tools\lib\utils.js:275:49)
    at listOnTimeout (node:internal/timers:588:17)
    at process.processTimers (node:internal/timers:523:7)
[error] 
[error] Error: An unexpected error has occurred.
